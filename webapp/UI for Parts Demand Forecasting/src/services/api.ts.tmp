// Central API base — served by Django at /api
const BASE = '/api';

export type UserRole = 'manager' | 'approvisionnement' | 'logistique';
export interface User {
  id: string;
  nom: string;
  email: string;
  role: UserRole;
}

export async function apiLogin(usernameOrEmail: string, password: string) {
  const r = await fetch(`${BASE}/login`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ usernameOrEmail, password }),
  });
  if (!r.ok) return { success: false } as const;
  const data = await r.json();
  return data as { success: boolean; user?: User; token?: string };
}

export async function apiHealth() {
  const r = await fetch(`${BASE}/health`);
  return r.ok;
}

export async function apiGetPrevisions() {
  const r = await fetch(`${BASE}/previsions`);
  if (!r.ok) throw new Error('Failed to load previsions');
  return r.json();
}

export async function apiGetConsommations() {
  const r = await fetch(`${BASE}/consommations`);
  if (!r.ok) throw new Error('Failed to load consommations');
  return r.json();
}

export async function apiSaveConsommations(updates: Array<{ code: string; consommationReelle: number | null }>) {
  const r = await fetch(`${BASE}/consommations/save`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ updates }),
  });
  if (!r.ok) return { success: false } as const;
  return (await r.json()) as { success: boolean };
}

// Budget
export async function apiGetBudget() {
  const r = await fetch(`${BASE}/budget`);
  if (!r.ok) throw new Error('Failed to load budget');
  return r.json();
}

export async function apiToggleBudget(lineId: number) {
  const r = await fetch(`${BASE}/budget/toggle`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ line_id: lineId }),
  });
  return r.ok;
}

export async function apiToggleAllBudget() {
  const r = await fetch(`${BASE}/budget/toggle-all`, { method: 'POST' });
  return r.ok;
}

export async function apiApproveBudget() {
  const r = await fetch(`${BASE}/budget/approve`, { method: 'POST' });
  return r.ok;
}

// Alerts
export async function apiGetAlerts() {
  const r = await fetch(`${BASE}/alerts`);
  if (!r.ok) throw new Error('Failed to load alerts');
  return r.json();
}

export async function apiProcessAlert(alertId: number) {
  const r = await fetch(`${BASE}/alerts/process`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ alert_id: alertId }),
  });
  return r.ok;
}
